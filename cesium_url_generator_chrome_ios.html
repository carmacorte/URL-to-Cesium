let alertIntervalId = null;
let lastBoardQty = null;
let lastCheckedTime = null;

function startAlerts() {
  if (alertIntervalId) {
    alert("üîÅ Ya est√° activa la alerta.");
    return;
  }

  alert("‚úÖ Se activar√° un aviso cada 5 minutos con revisi√≥n de yield.");
  alertIntervalId = setInterval(async () => {
    if (latestURL) {
      try {
        const response = await fetch(latestURL);
        const html = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const boardQtyMatch = html.match(/Board Qty<\/th>\s*<td[^>]*>(\d+)<\/td>/);

        if (boardQtyMatch) {
          const newBoardQty = parseInt(boardQtyMatch[1]);
          const now = new Date();
          const nowTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          let message = `üïì Revisi√≥n de Yield: ${nowTime}\nBoard Qty: ${newBoardQty}`;

          if (lastBoardQty !== null) {
            const diff = newBoardQty - lastBoardQty;
            message += `\nCambio desde ${lastCheckedTime}: ${diff >= 0 ? "+" : ""}${diff}`;
          }

          alert(message);

          lastBoardQty = newBoardQty;
          lastCheckedTime = nowTime;
        } else {
          alert("‚ö†Ô∏è No se pudo leer Board Qty del HTML.");
        }
      } catch (error) {
        alert("‚ùå Error al obtener datos del URL:\n" + error.message);
      }
    } else {
      alert("‚ö†Ô∏è No se ha generado un URL todav√≠a.");
    }
  }, 5 * 60 * 1000); // 5 minutos = 300000 ms
}

function stopAlerts() {
  if (alertIntervalId) {
    clearInterval(alertIntervalId);
    alertIntervalId = null;
    alert("üõë Alerta detenida.");
  }
}